name: Specification Compliance

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'tests/spec-compliance/**'
      - 'package.json'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'tests/spec-compliance/**'
      - 'package.json'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  spec-compliance:
    name: OMATrust Specification Compliance
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci || npm install --legacy-peer-deps
        npm rebuild || true

    - name: Run Specification Compliance Tests
      id: spec-tests
      run: |
        npm test -- tests/spec-compliance/omatrust-spec --run 2>&1 | tee spec-test-output.txt
        echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Parse Test Results
      id: parse-results
      run: |
        # Extract test counts from output
        TOTAL=$(grep -oP 'Tests\s+\K\d+(?=\s+passed)' spec-test-output.txt || echo "0")
        PASSED=$(grep -oP '\d+(?=\s+passed)' spec-test-output.txt | head -1 || echo "0")
        FAILED=$(grep -oP '\d+(?=\s+failed)' spec-test-output.txt | head -1 || echo "0")
        
        # Calculate compliance percentage
        if [ "$TOTAL" -gt 0 ]; then
          COMPLIANCE=$(echo "scale=1; $PASSED * 100 / $TOTAL" | bc)
        else
          COMPLIANCE="0"
        fi
        
        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "failed=$FAILED" >> $GITHUB_OUTPUT
        echo "compliance=$COMPLIANCE" >> $GITHUB_OUTPUT

    - name: Check Compliance Threshold
      run: |
        FAILED=${{ steps.parse-results.outputs.failed }}
        if [ "$FAILED" -gt 2 ]; then
          echo "❌ Specification compliance failed: $FAILED tests failing (threshold: 2 known issues)"
          exit 1
        else
          echo "✅ Specification compliance within acceptable threshold"
        fi

    - name: Generate Compliance Report
      if: always()
      run: |
        cat << EOF > compliance-report.md
        # OMATrust Specification Compliance Report
        
        **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Commit:** ${{ github.sha }}
        **Branch:** ${{ github.ref_name }}
        
        ## Test Results
        
        | Metric | Value |
        |--------|-------|
        | Total Tests | ${{ steps.parse-results.outputs.total }} |
        | Passed | ${{ steps.parse-results.outputs.passed }} |
        | Failed | ${{ steps.parse-results.outputs.failed }} |
        | Compliance | ${{ steps.parse-results.outputs.compliance }}% |
        
        ## Specifications Covered
        
        - OMATrust Identity Registry Specification
        - OMATrust Reputation Specification  
        - OMATrust Proof Specification
        
        ## Known Issues
        
        - \`did:pkh\` normalization bug (2 failing tests) - In Progress
        
        EOF

    - name: Upload Compliance Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: compliance-report
        path: compliance-report.md
        retention-days: 30

    - name: Comment PR with Compliance Status
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const total = '${{ steps.parse-results.outputs.total }}';
          const passed = '${{ steps.parse-results.outputs.passed }}';
          const failed = '${{ steps.parse-results.outputs.failed }}';
          const compliance = '${{ steps.parse-results.outputs.compliance }}';
          
          const status = parseInt(failed) <= 2 ? '✅' : '❌';
          const statusText = parseInt(failed) <= 2 ? 'PASSED' : 'FAILED';
          
          const body = `## ${status} OMATrust Specification Compliance ${statusText}
          
          | Metric | Value |
          |--------|-------|
          | **Total Tests** | ${total} |
          | **Passed** | ${passed} |
          | **Failed** | ${failed} |
          | **Compliance** | ${compliance}% |
          
          ### Specifications Tested
          - Identity Registry Specification
          - Reputation Specification
          - Proof Specification
          
          ${parseInt(failed) > 0 ? `\n⚠️ **Known Issues:** ${failed} test(s) failing due to \`did:pkh\` normalization bug (fix in progress)` : ''}
          
          ---
          *Generated by Specification Compliance Workflow*`;
          
          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('OMATrust Specification Compliance')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              comment_id: botComment.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          }

  coverage-report:
    name: Specification Coverage Analysis
    runs-on: ubuntu-latest
    needs: spec-compliance
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci || npm install --legacy-peer-deps

    - name: Generate Coverage Report
      run: npm test -- tests/spec-compliance/omatrust-spec --coverage --run || true

    - name: Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: spec-compliance
        name: spec-compliance-coverage
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

